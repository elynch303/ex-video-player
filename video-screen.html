<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-signals/core-signals.html">

<link rel="import" href="video-play-button.html">

<polymer-element name="video-screen"

                 on-screen-pause="{{pause}}"
                 on-screen-fullscreen="{{fullscreen}}">

  <template>
    <style>
      :host {
        display: block;
        width: 320px;
        height: 240px;
        position: relative;
      }
      :host > video {
        background-color: black;
      }
      :host > video-play-button, :host > video {
        display: block;
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
      }
      :host > video-play-button {
        z-index: 1;
      }
    </style>
    <video-play-button hidden?="{{hiddenPlayButton}}" on-click="{{playClick}}"></video-play-button>
    <video id="video" on-click="{{pauseClick}}">
      <content></content>
    </video>
    <content id="content" select="source"></content>
    <core-signals on-core-signal-play="{{play}}"></core-signals>
    <core-signals on-core-signal-pause="{{pause}}"></core-signals>
    <core-signals on-core-signal-change="{{change}}"></core-signals>
    <core-signals on-core-signal-fullscreen="{{fullscreen}}"></core-signals>
    <core-signals on-core-signal-volume="{{volume}}"></core-signals>
  </template>

  <script>

    Polymer({
      hiddenPlayButton: false,
      video: null,
      ready: function() {
        this.video = this.$.video;
        this.video.onended = this.ended.bind(this);
        this.video.addEventListener('play', this.playClick.bind(this), true);
        this.video.addEventListener('pause', this.pauseClick.bind(this), true);
        this.video.addEventListener("timeupdate", this.timeupdate.bind(this), true);
        this.video.addEventListener("progress", this.progress.bind(this), true);
        this.video.addEventListener("canplay", this.canplay.bind(this), true);
      },
      togglePlayButton: function () {
        this.hiddenPlayButton = this.hiddenPlayButton ? true : false;
      },
      playClick: function () {
        this.fire('core-signal', { name: "play" });
      },
      pauseClick: function() {
        this.fire('core-signal', { name: "pause" });
      },
      play: function() { this.video.play();  this.hiddenPlayButton = true; },
      pause: function() { this.video.pause(); this.hiddenPlayButton = false;},
      ended: function() {
        this.hiddenPlayButton = false;
      },
      timeupdate: function() {
        if(this.video.duration <= 0) return;
        var value = (100 / this.video.duration) * this.video.currentTime;
        this.fire('core-signal', { name: 'timeupdate', data: value });
      },
      progress: function() {
        if(this.video.duration <= 0 || this.video.buffered.length == 0) return;
        var buffered_end = this.video.buffered.end(this.video.buffered.length - 1);
        var progress_amount = (buffered_end / this.video.duration) * 100;
        this.fire('core-signal', { name: 'progress-amount', data: progress_amount });
      },
      canplay: function() {
        this.fire('core-signal', { name: 'canplay' });
      },
      change: function(e, detail, sender) {
        if(isNaN(this.video.duration)) return;
        var time = this.video.duration * (detail / 100);
        this.video.currentTime = time;
      },
      fullscreen: function() {
        if (this.video.requestFullscreen) {
          this.video.requestFullscreen();
        } else if (this.video.mozRequestFullScreen) {
          this.video.mozRequestFullScreen(); // Firefox
        } else if (this.video.webkitRequestFullscreen) {
          this.video.webkitRequestFullscreen(); // Chrome and Safari
        }
      },
      volume: function(e, detail, sender) {
        this.video.volume = detail
      }
    });

  </script>

</polymer-element>
